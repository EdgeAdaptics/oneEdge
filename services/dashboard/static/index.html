<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>oneEdge Control Center</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
    <script src="/static/app.js" defer></script>
</head>
<body>
    <nav class="top-nav">
        <div class="nav-brand">EdgeAdaptics oneEdge</div>
        <ul class="nav-links">
            <li><button data-nav="overview" class="nav-link active">Overview</button></li>
            <li class="nav-dropdown">
                <button class="nav-link">Devices â–¾</button>
                <div class="dropdown-menu">
                    <button data-nav="devices">Catalogue</button>
                    <button data-nav="onboarding">Onboarding Monitor</button>
                </div>
            </li>
            <li><button data-nav="alerts" class="nav-link">Alerts</button></li>
            <li><button data-nav="settings" class="nav-link">Settings</button></li>
        </ul>
    </nav>

    <main>
        <div class="view" data-view="overview">
            <section class="card">
                <h2>Live Metrics</h2>
                <table id="metrics-table">
                    <thead>
                        <tr>
                            <th>Machine</th>
                            <th>Metric</th>
                            <th>Value</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>
            <section class="card">
                <h2>Metric Trend</h2>
                <div class="chart-controls">
                    <label for="metric-select">Metric:</label>
                    <select id="metric-select"></select>
                    <label for="machine-select">Machine:</label>
                    <select id="machine-select"></select>
                </div>
                <canvas id="metric-chart"></canvas>
            </section>
        </div>

        <div class="view hidden" data-view="devices">
            <section class="card">
                <h2>Device Provisioning</h2>
                <form id="device-form" class="device-form">
                    <div class="grid">
                        <div class="form-row">
                            <label for="device-id">Device ID *</label>
                            <input id="device-id" name="device_id" required placeholder="pressline-01" />
                        </div>
                        <div class="form-row">
                            <label for="device-name">Name *</label>
                            <input id="device-name" name="name" required placeholder="Press Line 01" />
                        </div>
                        <div class="form-row">
                            <label for="device-type">Type</label>
                            <input id="device-type" name="device_type" placeholder="Compressor" />
                        </div>
                        <div class="form-row">
                            <label for="device-location">Location</label>
                            <input id="device-location" name="location" placeholder="Zone A" />
                        </div>
                        <div class="form-row">
                            <label for="device-status">Status</label>
                            <select id="device-status" name="status">
                                <option value="inactive">Inactive</option>
                                <option value="active">Active</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="decommissioned">Decommissioned</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid">
                        <div class="form-row">
                            <label for="device-auth-method">Auth Method</label>
                            <select id="device-auth-method" name="auth_method">
                                <option value="pre_shared_key">Pre-shared Key</option>
                                <option value="x509">X.509 Certificate</option>
                                <option value="token">Token-Based</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label for="device-auth-id">Auth Identifier</label>
                            <input id="device-auth-id" name="auth_id" placeholder="CN=device-01" />
                        </div>
                        <div class="form-row">
                            <label for="device-static-key">Device Static Key *</label>
                            <input id="device-static-key" name="device_static_key" placeholder="Unique secret for challenge signing" />
                        </div>
                        <div class="form-row">
                            <label for="device-rotation">Rotation Interval (hours)</label>
                            <input id="device-rotation" name="rotation_interval_hours" type="number" min="1" max="720" placeholder="168" />
                        </div>
                    </div>
                    <div class="grid">
                        <div class="form-row">
                            <label for="device-initial-secret">Bootstrap Secret (optional)</label>
                            <input id="device-initial-secret" name="initial_secret" placeholder="Auto-generate if blank" />
                        </div>
                        <div class="form-row">
                            <label for="device-hardware">Hardware Fingerprint</label>
                            <input id="device-hardware" name="hardware_fingerprint" placeholder="Immutable device fingerprint" />
                        </div>
                        <div class="form-row">
                            <label for="device-public-key">Device Public Key</label>
                            <input id="device-public-key" name="device_public_key" placeholder="BEGIN PUBLIC KEY..." />
                        </div>
                    </div>
                    <div class="form-row">
                        <label for="device-allowed-endpoints">Allowed Endpoints (comma-separated)</label>
                        <textarea id="device-allowed-endpoints" name="allowed_endpoints" placeholder="mqtt://192.168.1.10:1883, https://api.partner.example"></textarea>
                    </div>
                    <div class="form-row">
                        <label for="device-metadata">Metadata (JSON)</label>
                        <textarea id="device-metadata" name="metadata" placeholder='{"line": "A", "oee_target": 0.9}'></textarea>
                    </div>
                    <div class="form-row">
                        <label for="device-policy">Policy Template (JSON)</label>
                        <textarea id="device-policy" name="policy_template" placeholder='{"topics": {"telemetry": "oneEdge/devices/<id>/telemetry"}}'></textarea>
                    </div>
                    <button type="submit">Save Device</button>
                    <span id="device-feedback" class="form-feedback"></span>
                </form>
            </section>
            <section class="card">
                <h2>Device Catalogue</h2>
                <table id="devices-table">
                    <thead>
                        <tr>
                            <th>Device</th>
                            <th>Name</th>
                            <th>Auth</th>
                            <th>Status</th>
                            <th>Last Seen</th>
                            <th>Last Rotated</th>
                            <th>Attention</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>
        </div>

        <div class="view hidden" data-view="onboarding">
            <section class="card">
                <h2>Onboarding Monitor</h2>
                <p class="subtitle">Devices requiring attention (quarantined, stale, or rotation overdue).</p>
                <table id="attention-table">
                    <thead>
                        <tr>
                            <th>Device</th>
                            <th>Status</th>
                            <th>Flags</th>
                            <th>Last Seen</th>
                            <th>Challenge Expires</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>
        </div>

        <div class="view hidden" data-view="alerts">
            <section class="card">
                <h2>Active Alerts</h2>
                <ul id="alerts-list"></ul>
            </section>
        </div>

        <div class="view hidden" data-view="settings">
            <section class="card">
                <h2>Security & TLS</h2>
                <p>Enable HTTPS by updating <code>dashboard.tls</code> in <code>configs/oneedge.yaml</code> and mounting certificates to <code>/certs</code>. Example:</p>
                <pre><code>dashboard:
  tls:
    enabled: true
    certfile: "/certs/server.crt"
    keyfile: "/certs/server.key"</code></pre>
                <p>Generate a self-signed certificate for testing:</p>
                <pre><code>mkdir -p certs
openssl req -x509 -newkey rsa:4096 -keyout certs/server.key   -out certs/server.crt -days 365 -nodes -subj "/CN=oneedge.local"</code></pre>
                <p>Then redeploy with <code>docker compose down -v</code> followed by <code>docker compose up -d</code>.</p>
            </section>
            <section class="card">
                <h2>Simulator</h2>
                <p>Use the onboarding simulator to exercise the zero-trust workflow:</p>
                <pre><code>python scripts/device_onboarding_sim.py pressline-01   --base-url https://oneedge.local:8443   --mqtt-host oneedge.local --use-secret-mqtt</code></pre>
                <p>The script provisions the device (optional), performs the challenge/response handshake, and publishes sample telemetry.</p>
            </section>
        </div>
    </main>
</body>
</html>
